<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>GuardianSOS Live Tracking</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: #050510;
            color: #f5f5f5;
        }
        .header {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .app-name {
            font-weight: 700;
            letter-spacing: 0.04em;
            font-size: 14px;
            text-transform: uppercase;
            color: #ff4b6a;
        }
        .status-pill {
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: #25d366;
        }
        .status-pill.active {
            background: rgba(255, 75, 106, 0.12);
            color: #ff97ac;
        }
        .status-pill.ended {
            background: rgba(255, 255, 255, 0.08);
            color: #cccccc;
        }
        .status-pill.active .status-dot {
            background: #ff4b6a;
        }

        #map {
            width: 100%;
            height: 55vh;
        }

        .panel {
            padding: 16px 20px 24px;
        }

        .label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            opacity: 0.6;
        }

        .value {
            font-size: 15px;
            margin-bottom: 10px;
        }

        .card {
            background: rgba(255,255,255,0.04);
            border-radius: 16px;
            padding: 14px 16px;
            margin-top: 12px;
            border: 1px solid rgba(255,255,255,0.06);
        }

        .row {
            display: flex;
            justify-content: space-between;
            gap: 12px;
        }
        .row > div {
            flex: 1;
        }

        .footer-note {
            margin-top: 18px;
            font-size: 11px;
            opacity: 0.55;
            line-height: 1.5;
        }

        @media (min-width: 768px) {
            #map { height: 60vh; }
            .panel { max-width: 640px; margin: 0 auto; }
        }
    </style>

    <!-- REPLACE WITH YOUR REAL GOOGLE MAPS KEY -->
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_KEY"></script>
</head>
<body>

    <div class="header">
        <div class="app-name">GuardianSOS</div>
        <div id="status-pill" class="status-pill ended">
            <div class="status-dot"></div>
            <span id="status-text">Loading...</span>
        </div>
    </div>

    <div id="map"></div>

    <div class="panel">
        <div class="card">
            <div class="label">Person</div>
            <div class="value" id="name">Loading...</div>

            <div class="row">
                <div>
                    <div class="label">Last updated</div>
                    <div class="value" id="updated">—</div>
                </div>
                <div>
                    <div class="label">Status</div>
                    <div class="value" id="status-label">—</div>
                </div>
            </div>

            <div class="row">
                <div>
                    <div class="label">Latitude</div>
                    <div class="value" id="lat">—</div>
                </div>
                <div>
                    <div class="label">Longitude</div>
                    <div class="value" id="lng">—</div>
                </div>
            </div>
        </div>

        <div class="footer-note">
            This page updates automatically every few seconds. If you believe
            the person is in immediate danger, contact local emergency services
            and share their last known location.
        </div>
    </div>

    <script>
        const sosId = window.location.pathname.split('/').pop();

        let map, marker;

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 15,
                center: { lat: 0, lng: 0 },
                styles: [
                    { "featureType": "poi", "stylers": [{ "visibility": "off" }] },
                    { "featureType": "transit", "stylers": [{ "visibility": "off" }] }
                ]
            });

            marker = new google.maps.Marker({
                map,
                title: "Last known location"
            });
        }

        function setStatusPill(status) {
            const pill = document.getElementById("status-pill");
            const text = document.getElementById("status-text");

            if (status === "active") {
                pill.classList.remove("ended");
                pill.classList.add("active");
                text.innerText = "SOS ACTIVE";
            } else {
                pill.classList.remove("active");
                pill.classList.add("ended");
                text.innerText = "SAFE / ENDED";
            }
        }

        function updateUI(data) {
            document.getElementById("name").innerText = data.displayName || "Unknown";
            document.getElementById("status-label").innerText = (data.status || "").toUpperCase();

            if (data.lastLocation) {
                document.getElementById("updated").innerText = new Date(data.lastLocation.timestamp).toLocaleString();
                document.getElementById("lat").innerText = data.lastLocation.latitude.toFixed(5);
                document.getElementById("lng").innerText = data.lastLocation.longitude.toFixed(5);
            } else {
                document.getElementById("updated").innerText = "No location yet";
                document.getElementById("lat").innerText = "—";
                document.getElementById("lng").innerText = "—";
            }

            setStatusPill(data.status);
        }

        function updateMap(loc) {
            if (!loc) return;
            const pos = { lat: loc.latitude, lng: loc.longitude };
            marker.setPosition(pos);
            map.setCenter(pos);
        }

        async function fetchStatus() {
            try {
                const res = await fetch(`/api/live/${sosId}`);
                if (!res.ok) {
                    console.warn("Failed to load session", res.status);
                    return;
                }
                const data = await res.json();
                updateUI(data);
                updateMap(data.lastLocation);
            } catch (e) {
                console.error("Error fetching status", e);
            }
        }

        initMap();
        fetchStatus();
        setInterval(fetchStatus, 5000);
    </script>
</body>
</html>
